<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>解读 OpenHarmony 系统开机动画源码 | 名無し's Blog</title><meta name="author" content="名無し"><meta name="copyright" content="名無し"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文将基于 OpenHarmony 3.2 源码，分析 Graphic 子系统 2D 图形库中的 OpenHarmony 系统开机动画源码。"><meta property="og:type" content="article"><meta property="og:title" content="解读 OpenHarmony 系统开机动画源码"><meta property="og:url" content="https://hydrotho.github.io/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/"><meta property="og:site_name" content="名無し&#39;s Blog"><meta property="og:description" content="本文将基于 OpenHarmony 3.2 源码，分析 Graphic 子系统 2D 图形库中的 OpenHarmony 系统开机动画源码。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://hydrotho.github.io/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/cover.webp"><meta property="article:published_time" content="2022-09-15T04:00:00.000Z"><meta property="article:modified_time" content="2022-09-15T04:00:00.000Z"><meta property="article:author" content="名無し"><meta property="article:tag" content="OpenHarmony"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://hydrotho.github.io/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/cover.webp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://hydrotho.github.io/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//static.cloudflareinsights.com"><meta name="google-site-verification" content="xyC7ab22fH2WUsJjC83-VhBuopXXLkyj9ekvylz-dFs"><meta name="msvalidate.01" content="D5991F5AD2163493D893F8EC8DEA09E3"><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script async src="https://www.googletagmanager.com/gtag/js?id=UA-180228104-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-180228104-1")</script><script defer data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;6a7bfb63a151490cbae052c9cbb96789&quot;}"></script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"prismjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体中文",cht_to_chs:"你已切换为简体中文",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"解读 OpenHarmony 系统开机动画源码",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-09-15 12:00:00"}</script><script>(e=>{e.saveToLocal={set:(e,t,a)=>{var o;0!==a&&(o=Date.now(),localStorage.setItem(e,JSON.stringify({value:t,expiry:o+864e5*a})))},get:e=>{var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!(Date.now()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=(o,c={})=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},Object.keys(c).forEach(e=>{a.setAttribute(e,c[e])}),document.head.appendChild(a)}),e.getCSS=(o,c=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,c&&(a.id=c),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};var e=saveToLocal.get("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,o=window.matchMedia("(prefers-color-scheme: no-preference)").matches,c=!t&&!a&&!o,t=(void 0===e?(a?activateLightMode():t?activateDarkMode():(o||c)&&((a=(new Date).getHours())<=6||18<=a?activateDarkMode:activateLightMode)(),window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode:activateLightMode)()})):("light"===e?activateLightMode:activateDarkMode)(),saveToLocal.get("aside-status"));void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="名無し's Blog" type="application/atom+xml"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{const d=document.getElementById("loading-box"),e=document.body,o={endLoading:()=>{e.style.overflow="",d.classList.add("loaded")},initLoading:()=>{e.style.overflow="hidden",d.classList.remove("loaded")}};o.initLoading(),window.addEventListener("load",()=>{o.endLoading()})})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.webp" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/cover.webp)"><nav id="nav"><span id="blog-info"><a href="/" title="名無し's Blog"><span class="site-name">名無し's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">解读 OpenHarmony 系统开机动画源码</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-09-15T04:00:00.000Z" title="发表于 2022-09-15 12:00:00">2022-09-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-09-15T04:00:00.000Z" title="更新于 2022-09-15 12:00:00">2022-09-15</time></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>本文将基于 OpenHarmony 3.2 源码，分析 Graphic 子系统 2D 图形库中的 OpenHarmony 系统开机动画源码。</p><p>开机动画是 OpenHarmony 启动后，运行的第一个和图形渲染相关的进程，依赖相对独立便于分析，是分析图形子系统比较好的切入点。</p><h2 id="源码仓库"><a href="#源码仓库" class="headerlink" title="源码仓库"></a>源码仓库</h2><div class="note warning flat"><p>本文基于 OpenHarmony 3.2 源码。</p><p>由于 OpenHarmony 尚未稳定，源代码和项目仓库结构变更速度和幅度都较大，请读者直接参照 OpenHarmony 3.2 源码阅读本文。</p></div><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://gitee.com/openharmony/graphic_graphic_2d">Graphic 子系统 2D 图形库源码</a></p><p>仓库结构</p><pre class="language-textile" data-language="textile"><code class="language-textile"><span class="token phrase">foundation/graphic/graphic_2d/
├── figures                 # Markdown 引用的图片目录
├── frameworks              # 框架代码目录
│   ├── animation_server    # animation_server 代码
│   ├── bootanimation       # 开机动画目录
│   ├── dumper              # graphic dumper 代码
│   ├── fence               # fence 代码
│   ├── opengl_wrapper      # opengl_wrapper
│   ├── surface             # surface 代码
│   ├── surfaceimage        # surfaceimage 代码
│   ├── vsync               # vsync 代码
│   ├── wm                  # wm 代码
│   ├── wmserver            # wmserver 代码
│   ├── wmservice           # wmservice 代码
│   ├── wmtest              # wmtest 代码
├── rosen                   # 框架代码目录
│   ├── build               # 构建说明
│   ├── doc                 # doc
│   ├── include             # 对外头文件代码
│   ├── modules             # Graphic 子系统各模块代码
│   ├── samples             # 实例代码
│   ├── test                # 开发测试代码
│   ├── tools               # 工具代码
├── interfaces              # 图形接口存放目录
│   ├── inner_api           # 内部 native 接口存放目录
│   └── kits                # js/napi 外部接口存放目录
└── utils                   # 小部件存放目录</span></code></pre><img src="/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/EC90646CC76B15B23CED1322A21C6FF4.webp" title="Graphic 子系统主要结构"><h2 id="前导知识：构建目标"><a href="#前导知识：构建目标" class="headerlink" title="前导知识：构建目标"></a>前导知识：构建目标</h2><div class="note info flat"><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://gitee.com/openharmony/docs/blob/master/zh-cn/device-dev/subsystems/subsys-build-all.md">官方编译构建指导</a></p></div><p>一般情况下，我们使用最基础的全量编译，也就是编译产品。但在开发过程中，修改一部分代码后，若我们每次都采用全量编译，则十分浪费时间。</p><p>好在 OpenHarmony 的编译构建工具支持部分编译，我们可以指定编译目标：</p><pre class="language-bash" data-language="bash"><code class="language-bash">./build.sh --product-name<span class="token operator">=</span><span class="token operator">&lt;</span>PRODUCT_NAME<span class="token operator">></span> --build-target<span class="token operator">=</span><span class="token operator">&lt;</span>BUILD_TARGET<span class="token operator">></span> <span class="token parameter variable">--ccache</span></code></pre><div class="note info flat"><p>OpenHarmony 的 <code>hb</code> 命令行工具也支持指定编译目标，请自行查阅手册。</p></div><p>这里简单分析一下 OpenHarmony 系统开机动画源码是如何被加入构建编译的。</p><p>我们先抛开平台和产品的差异，假设构建编译包含了 Graphic 子系统。OpenHarmony 中所有子系统的定义可以在 <code>build/subsystem_config.json</code> 中找到，Graphic 子系统也不例外：</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"sensors"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"base/sensors"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"sensors"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"graphic"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"foundation/graphic"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"graphic"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"window"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"foundation/window"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"window"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span></code></pre><p>由此可知 Graphic 子系统位于 <code>foundation/graphic</code> 目录，本文的主角 OpenHarmony 系统开机动画源码就在该目录中 <code>foundation/graphic/graphic_2d/frameworks/bootanimation</code>。</p><p>首先我们关注 <code>bootanimation</code> 目录下的 <code>BUILD.gn</code> 文件：</p><pre class="language-gn" data-language="gn"><code class="language-gn"><span class="token function">ohos_executable</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"bootanimation"</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  install_enable <span class="token operator">=</span> <span class="token boolean">true</span>

  sources <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string-literal"><span class="token string">"src/boot_animation.cpp"</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">"src/main.cpp"</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">"src/util.cpp"</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
…………
…………
…………
  part_name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"graphic_standard"</span></span>
  subsystem_name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"graphic"</span></span>
<span class="token punctuation">&#125;</span>

<span class="token function">ohos_prebuilt_etc</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"bootanimation_pics"</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  source <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"data/bootpic.zip"</span></span>
  relative_install_dir <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"init"</span></span>
  part_name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"graphic_standard"</span></span>
  subsystem_name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"graphic"</span></span>
<span class="token punctuation">&#125;</span>

<span class="token function">ohos_prebuilt_etc</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"bootanimation_sounds"</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  source <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"data/bootsound.wav"</span></span>
  relative_install_dir <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"init"</span></span>
  part_name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"graphic_standard"</span></span>
  subsystem_name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"graphic"</span></span>
<span class="token punctuation">&#125;</span></code></pre><ul><li><code>bootanimation</code> 编译生成二进制可执行文件，并在全量编译时将生成的文件复制到 <code>/system/bin</code> 目录</li><li><code>bootanimation_pics</code> 在全量编译时将开机动画图片压缩包复制到 <code>/system/bin/init</code> 目录</li><li><code>bootanimation_sounds</code> 在全量编译时将开机动画音效文件复制到 <code>/system/bin/init</code> 目录</li></ul><p>现在，让我们回到父目录 <code>foundation/graphic/graphic_2d</code>。</p><p>查看该目录下的 <code>BUILD.gn</code> 文件：</p><pre class="language-gn" data-language="gn"><code class="language-gn"><span class="token function">group</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"default"</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  public_deps <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string-literal"><span class="token string">":graphic.rc"</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">"frameworks/dumper:gdumper"</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">"frameworks/dumper:gdumper.ini"</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">"frameworks/dumper:graphic_dumper_server"</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">"frameworks/vsync:vsync_server"</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>graphic_standard_feature_bootanimation_enable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    public_deps <span class="token operator">+=</span> <span class="token punctuation">[</span> <span class="token string-literal"><span class="token string">"frameworks/bootanimation:bootanimation"</span></span> <span class="token punctuation">]</span>
    public_deps <span class="token operator">+=</span> <span class="token punctuation">[</span> <span class="token string-literal"><span class="token string">"frameworks/bootanimation:bootanimation_pics"</span></span> <span class="token punctuation">]</span>
    public_deps <span class="token operator">+=</span> <span class="token punctuation">[</span> <span class="token string-literal"><span class="token string">"frameworks/bootanimation:bootanimation_sounds"</span></span> <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre><p>查看该目录下的 <code>bundle.json</code> 文件</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  …………
  …………
  …………
  <span class="token property">"build"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"sub_component"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"//third_party/libpng:libpng"</span><span class="token punctuation">,</span>
      <span class="token string">"//foundation/graphic/graphic_2d:default"</span><span class="token punctuation">,</span>
      <span class="token string">"//foundation/graphic/graphic_2d/interfaces/kits/napi:napi_packages"</span><span class="token punctuation">,</span>
      …………
      …………
      …………
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    …………
    …………
    …………
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  …………
  …………
  …………
<span class="token punctuation">&#125;</span></code></pre><p>通过分析这两个文件，我们得知构建 OpenHarmony 系统开机动画源码所需的编译目标就是 <code>foundation/graphic/graphic_2d:default</code>。</p><p>假设我们使用的产品为 <code>vendor/hihope/rk3568</code>，则可以这样编译构建 OpenHarmony 系统开机动画源码：</p><pre class="language-bash" data-language="bash"><code class="language-bash">./build.sh --product-name<span class="token operator">=</span>rk3568 --build-target<span class="token operator">=</span>foundation/graphic/graphic_2d:default <span class="token parameter variable">--ccache</span></code></pre><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>接下来，本文将解读开机动画源码 <code>foundation/graphic/graphic_2d/frameworks/bootanimation</code>。</p><div class="note info flat"><p>OpenHarmony 的 2D 图形库底层使用的是 Google 开源的 Skia 2D 图形库。</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://skia.org/">Skia 官网</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://skia.org/docs/">Skia 文档</a></p><p>下文以 <code>Sk</code> 开头的都属于该库，读者可以查阅 Skia 文档进一步了解。</p></div><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>开机动画的启动流程定义在 <code>foundation/graphic/graphic_2d/graphic.cfg</code> 文件中：</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"jobs"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
            <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"init"</span><span class="token punctuation">,</span>
            <span class="token property">"cmds"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"chmod 666 /dev/mali0"</span><span class="token punctuation">,</span>
                <span class="token string">"chown system graphics /dev/mali0"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"services"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
            <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"render_service"</span><span class="token punctuation">,</span>
            <span class="token property">"path"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/system/bin/render_service"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"uid"</span> <span class="token operator">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span>
            <span class="token property">"gid"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"shell"</span><span class="token punctuation">,</span> <span class="token string">"uhid"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"caps"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"SYS_NICE"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"secon"</span> <span class="token operator">:</span> <span class="token string">"u:r:render_service:s0"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"bootanimation"</span><span class="token punctuation">,</span>
            <span class="token property">"path"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/system/bin/bootanimation"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"once"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">"uid"</span> <span class="token operator">:</span> <span class="token string">"graphics"</span><span class="token punctuation">,</span>
            <span class="token property">"gid"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"graphics"</span><span class="token punctuation">,</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"shell"</span><span class="token punctuation">,</span> <span class="token string">"uhid"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"secon"</span> <span class="token operator">:</span> <span class="token string">"u:r:bootanimation:s0"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre><p>OpenHarmony 分别启动了 <code>render_service</code> 和 <code>bootanimation</code> 以显示开机动画。</p><h3 id="初始化工作"><a href="#初始化工作" class="headerlink" title="初始化工作"></a>初始化工作</h3><p><code>src/main.cpp</code></p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"main enter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">WaitRenderServiceInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span><span class="token operator">&amp;</span> dms <span class="token operator">=</span> OHOS<span class="token double-colon punctuation">::</span>Rosen<span class="token double-colon punctuation">::</span><span class="token class-name">DisplayManager</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> displays <span class="token operator">=</span> dms<span class="token punctuation">.</span><span class="token function">GetAllDisplays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>displays<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"displays is empty, retry to get displays"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        displays <span class="token operator">=</span> dms<span class="token punctuation">.</span><span class="token function">GetAllDisplays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    BootAnimation bootAnimation<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> runner <span class="token operator">=</span> AppExecFwk<span class="token double-colon punctuation">::</span><span class="token class-name">EventRunner</span><span class="token double-colon punctuation">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> handler <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>AppExecFwk<span class="token double-colon punctuation">::</span>EventHandler<span class="token operator">></span></span></span><span class="token punctuation">(</span>runner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    handler<span class="token operator">-></span><span class="token function">PostTask</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>BootAnimation<span class="token double-colon punctuation">::</span>Init<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bootAnimation<span class="token punctuation">,</span>
        displays<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">GetWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> displays<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">GetHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">,</span> runner<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    handler<span class="token operator">-></span><span class="token function">PostTask</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>BootAnimation<span class="token double-colon punctuation">::</span>PlaySound<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bootAnimation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    runner<span class="token operator">-></span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"main exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p><code>WaitRenderServiceInit()</code> 定义在 <code>src/util.cpp</code> 中，其作用就是等待直到 <code>render_service</code> 就绪后返回。</p><p>程序通过 Rosen 框架获取 DisplayManager 实例并取得当前屏幕参数，随后利用 <code>PostTask</code> 函数将 <code>BootAnimation::Init</code> 和 <code>BootAnimation::PlaySound</code> 加入任务队列。</p><p><code>BootAnimation::Init</code> 中 <code>BootAnimation::InitBootWindow</code> 创建启动窗口，通过 WindowScene 调用 WindowImpl 创建 RSSurfaceNode 对象。</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp">sptr<span class="token operator">&lt;</span>OHOS<span class="token double-colon punctuation">::</span>Rosen<span class="token double-colon punctuation">::</span>WindowOption<span class="token operator">></span> option <span class="token operator">=</span> <span class="token keyword">new</span> OHOS<span class="token double-colon punctuation">::</span><span class="token class-name">Rosen</span><span class="token double-colon punctuation">::</span><span class="token function">WindowOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
option<span class="token operator">-></span><span class="token function">SetWindowType</span><span class="token punctuation">(</span>OHOS<span class="token double-colon punctuation">::</span>Rosen<span class="token double-colon punctuation">::</span>WindowType<span class="token double-colon punctuation">::</span>WINDOW_TYPE_BOOT_ANIMATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
option<span class="token operator">-></span><span class="token function">RemoveWindowFlag</span><span class="token punctuation">(</span>OHOS<span class="token double-colon punctuation">::</span>Rosen<span class="token double-colon punctuation">::</span>WindowFlag<span class="token double-colon punctuation">::</span>WINDOW_FLAG_NEED_AVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>
option<span class="token operator">-></span><span class="token function">SetWindowRect</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> windowWidth_<span class="token punctuation">,</span> windowHeight_<span class="token punctuation">&#125;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li><p><code>option-&gt;SetWindowType(OHOS::Rosen::WindowType::WINDOW_TYPE_BOOT_ANIMATION);</code></p><p>WindowType 定义在 <code>foundation/window/window_manager/interfaces/innerkits/wm/wm_common.h</code> 中，这里使用的是 WINDOW_TYPE_BOOT_ANIMATION 。值得注意的是，<code>wm_common.h</code> 中并不是所有列出的 WindowType 都可以使用，可用的 WindowType 类型可参考 <code>foundation/window/window_manager/wmserver/include/window_zorder_policy.h</code> 文件。</p></li><li><p><code>option-&gt;RemoveWindowFlag(OHOS::Rosen::WindowFlag::WINDOW_FLAG_NEED_AVOID);</code></p><p>WindowOption 初始化时，自动添加了 WINDOW_FLAG_NEED_AVOID（见 <code>foundation/window/window_manager/wm/src/window_option.cpp</code>），这一步将其移除。</p></li><li><p><code>option-&gt;SetWindowRect( &#123;0, 0, windowWidth_, windowHeight_&#125; );</code></p><p>根据先前通过 DisplayManager 获取到的屏幕参数设置窗口区域。</p></li></ul><p><code>BootAnimation::Init</code> 中 <code>BootAnimation::InitRsSurface</code> 创建获取 Surface。</p><p><code>BootAnimation::Init</code> 中 <code>BootAnimation::InitPicCoordinates</code> 计算得出开机动画的实际显示区域，大致上就是屏幕居中的位置。</p><p><code>ReadZipFile</code> 和 <code>SortZipFile</code> 函数不是我们关注的重点，其主要作用是解压开机动画图片压缩包，并将其按序添加至 <code>ImageStructVec imageVector_</code>。</p><p>我们需要关注的是其中的 <code>GenImageData</code> 函数：</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">bool</span> <span class="token function">GenImageData</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> filename<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>ImageStruct<span class="token operator">></span> imagetruct<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> bufferlen<span class="token punctuation">,</span>
    ImageStructVec<span class="token operator">&amp;</span> outBgImgVec<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>imagetruct<span class="token operator">-></span>memPtr<span class="token punctuation">.</span>memBuffer <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"Json File buffer is null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">auto</span> skData <span class="token operator">=</span> <span class="token class-name">SkData</span><span class="token double-colon punctuation">::</span><span class="token function">MakeFromMalloc</span><span class="token punctuation">(</span>imagetruct<span class="token operator">-></span>memPtr<span class="token punctuation">.</span>memBuffer<span class="token punctuation">,</span> bufferlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>skData <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"skdata memory data is null. update data failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    imagetruct<span class="token operator">-></span>memPtr<span class="token punctuation">.</span><span class="token function">setOwnerShip</span><span class="token punctuation">(</span>skData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> codec <span class="token operator">=</span> <span class="token class-name">SkCodec</span><span class="token double-colon punctuation">::</span><span class="token function">MakeFromData</span><span class="token punctuation">(</span>skData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    imagetruct<span class="token operator">-></span>fileName <span class="token operator">=</span> filename<span class="token punctuation">;</span>
    imagetruct<span class="token operator">-></span>imageData <span class="token operator">=</span> <span class="token class-name">SkImage</span><span class="token double-colon punctuation">::</span><span class="token function">MakeFromEncoded</span><span class="token punctuation">(</span>skData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    outBgImgVec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>imagetruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p><code>SkCodec::MakeFromData</code>，<code>SkCodec::MakeFromData</code> 和 <code>SkImage::MakeFromEncoded</code> 三个函数合力将从图片文件读至内存的数据转换为 SkImage 类型数据用于后续画面渲染。</p><p>开机动画图压缩包中还有个 <code>config.json</code> 文件，它定义了开机动画的帧率：</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"Remark"</span><span class="token operator">:</span> <span class="token string">"FrameRate Support 30, 60 frame rate configuration"</span><span class="token punctuation">,</span>
  <span class="token property">"FrameRate"</span><span class="token operator">:</span> <span class="token number">30</span>
<span class="token punctuation">&#125;</span></code></pre><p>随后，程序根据读取到的开机动画帧率，设置帧回调函数的调用速率。</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp">OHOS<span class="token double-colon punctuation">::</span>Rosen<span class="token double-colon punctuation">::</span>VSyncReceiver<span class="token double-colon punctuation">::</span>FrameCallback fcb <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>userData_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>callback_ <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>BootAnimation<span class="token double-colon punctuation">::</span>OnVsync<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int32_t</span> changefreq <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1000.0</span> <span class="token operator">/</span> freq_<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ret <span class="token operator">=</span> receiver_<span class="token operator">-></span><span class="token function">SetVSyncRate</span><span class="token punctuation">(</span>fcb<span class="token punctuation">,</span> changefreq<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>每次回调都会调用 <code>BootAnimation::OnVsync</code>，向任务队列添加一次 <code>BootAnimation::Draw</code> 任务。</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">BootAnimation</span><span class="token double-colon punctuation">::</span><span class="token function">OnVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">PostTask</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>BootAnimation<span class="token double-colon punctuation">::</span>Draw<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><h3 id="渲染绘制开机动画"><a href="#渲染绘制开机动画" class="headerlink" title="渲染绘制开机动画"></a>渲染绘制开机动画</h3><div class="note info flat"><p>aa64564b feat: 增加开机音频</p></div><p><code>BootAnimation::Init</code> 任务结束后，<code>BootAnimation::PlaySound</code> 通过多媒体子系统创建播放器，开始播放开机动画音效。</p><p>接下来正式开始绘制：</p><p><code>BootAnimation::Draw</code> 和 <code>BootAnimation::OnDraw</code></p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">BootAnimation</span><span class="token double-colon punctuation">::</span><span class="token function">Draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>picCurNo_ <span class="token operator">&lt;</span> <span class="token punctuation">(</span>imgVecSize_ <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        picCurNo_ <span class="token operator">=</span> picCurNo_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">CheckExitAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">ROSEN_TRACE_BEGIN</span><span class="token punctuation">(</span>HITRACE_TAG_GRAPHIC_AGP<span class="token punctuation">,</span> <span class="token string">"BootAnimation::Draw RequestFrame"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> frame <span class="token operator">=</span> rsSurface_<span class="token operator">-></span><span class="token function">RequestFrame</span><span class="token punctuation">(</span>windowWidth_<span class="token punctuation">,</span> windowHeight_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"Draw frame is nullptr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">ROSEN_TRACE_END</span><span class="token punctuation">(</span>HITRACE_TAG_GRAPHIC_AGP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    framePtr_ <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> canvas <span class="token operator">=</span> framePtr_<span class="token operator">-></span><span class="token function">GetCanvas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">OnDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> picCurNo_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ROSEN_TRACE_BEGIN</span><span class="token punctuation">(</span>HITRACE_TAG_GRAPHIC_AGP<span class="token punctuation">,</span> <span class="token string">"BootAnimation::Draw FlushFrame"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rsSurface_<span class="token operator">-></span><span class="token function">FlushFrame</span><span class="token punctuation">(</span>framePtr_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ROSEN_TRACE_END</span><span class="token punctuation">(</span>HITRACE_TAG_GRAPHIC_AGP<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">BootAnimation</span><span class="token double-colon punctuation">::</span><span class="token function">OnDraw</span><span class="token punctuation">(</span>SkCanvas<span class="token operator">*</span> canvas<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> curNo<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>canvas <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"OnDraw canvas is nullptr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curNo <span class="token operator">></span> <span class="token punctuation">(</span>imgVecSize_ <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> curNo <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>ImageStruct<span class="token operator">></span> imgstruct <span class="token operator">=</span> imageVector_<span class="token punctuation">[</span>curNo<span class="token punctuation">]</span><span class="token punctuation">;</span>
    sk_sp<span class="token operator">&lt;</span>SkImage<span class="token operator">></span> image <span class="token operator">=</span> imgstruct<span class="token operator">-></span>imageData<span class="token punctuation">;</span>

    <span class="token function">ROSEN_TRACE_BEGIN</span><span class="token punctuation">(</span>HITRACE_TAG_GRAPHIC_AGP<span class="token punctuation">,</span> <span class="token string">"BootAnimation::OnDraw in drawRect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SkPaint backPaint<span class="token punctuation">;</span>
    backPaint<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>SK_ColorBLACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token operator">-></span><span class="token function">drawRect</span><span class="token punctuation">(</span><span class="token class-name">SkRect</span><span class="token double-colon punctuation">::</span><span class="token function">MakeXYWH</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> windowWidth_<span class="token punctuation">,</span> windowHeight_<span class="token punctuation">)</span><span class="token punctuation">,</span> backPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ROSEN_TRACE_END</span><span class="token punctuation">(</span>HITRACE_TAG_GRAPHIC_AGP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ROSEN_TRACE_BEGIN</span><span class="token punctuation">(</span>HITRACE_TAG_GRAPHIC_AGP<span class="token punctuation">,</span> <span class="token string">"BootAnimation::OnDraw in drawImageRect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SkPaint paint<span class="token punctuation">;</span>
    SkRect rect<span class="token punctuation">;</span>
    rect<span class="token punctuation">.</span><span class="token function">setXYWH</span><span class="token punctuation">(</span>pointX_<span class="token punctuation">,</span> pointY_<span class="token punctuation">,</span> realWidth_<span class="token punctuation">,</span> realHeight_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token operator">-></span><span class="token function">drawImageRect</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rect<span class="token punctuation">,</span> <span class="token operator">&amp;</span>paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ROSEN_TRACE_END</span><span class="token punctuation">(</span>HITRACE_TAG_GRAPHIC_AGP<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><ul><li><p><code>Draw</code> 函数：<code>auto frame = rsSurface_-&gt;RequestFrame(windowWidth_, windowHeight_);</code></p><p>通过初始化阶段获取到的 Surface 申请 Frame</p></li><li><p><code>Draw</code> 函数：<code>framePtr_ = std::move(frame); auto canvas = framePtr_-&gt;GetCanvas();</code></p><p>获取 SkCanvas 对象</p></li><li><p><code>OnDraw</code> 函数：<code>canvas-&gt;drawRect(SkRect::MakeXYWH(0.0, 0.0, windowWidth_, windowHeight_), backPaint);</code></p><p><code>windowWidth_</code> 和 <code>windowHeight_</code> 为当前屏幕真实大小，该函数将整块屏幕填满黑色</p></li><li><p><code>OnDraw</code> 函数：<code>rect.setXYWH(pointX_, pointY_, realWidth_, realHeight_);</code></p><p>通过初始化阶段计算得出的开机动画实际显示区域，设置绘制区域</p></li><li><p><code>OnDraw</code> 函数：<code>canvas-&gt;drawImageRect(image.get(), rect, &amp;paint);</code></p><p>将从图片文件中转换得到的 SkImage 数据渲染到设置好的开机动画实际显示区域</p></li><li><p><code>Draw</code> 函数：<code>rsSurface_-&gt;FlushFrame(framePtr_);</code></p><p>将渲染好的画布数据（纯黑背景 + 一张图片）刷入 Surface 的 BufferQueue 以真正显示到物理屏幕</p></li></ul><p><code>foundation/graphic/graphic_2d/frameworks/surface/src/buffer_queue.cpp</code></p><pre class="language-cpp" data-language="cpp"><code class="language-cpp">GSError <span class="token class-name">BufferQueue</span><span class="token double-colon punctuation">::</span><span class="token function">FlushBuffer</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> sequence<span class="token punctuation">,</span> <span class="token keyword">const</span> sptr<span class="token operator">&lt;</span>BufferExtraData<span class="token operator">></span> <span class="token operator">&amp;</span>bedata<span class="token punctuation">,</span>
    <span class="token keyword">const</span> sptr<span class="token operator">&lt;</span>SyncFence<span class="token operator">></span><span class="token operator">&amp;</span> fence<span class="token punctuation">,</span> <span class="token keyword">const</span> BufferFlushConfig <span class="token operator">&amp;</span>config<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    ScopedBytrace <span class="token function">func</span><span class="token punctuation">(</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">BLOGN_FAILURE_RET</span><span class="token punctuation">(</span>GSERROR_NO_CONSUMER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">auto</span> sret <span class="token operator">=</span> <span class="token function">CheckFlushConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sret <span class="token operator">!=</span> GSERROR_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">BLOGN_FAILURE_API</span><span class="token punctuation">(</span>CheckFlushConfig<span class="token punctuation">,</span> sret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sret<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#123;</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lockGuard</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferQueueCache_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>sequence<span class="token punctuation">)</span> <span class="token operator">==</span> bufferQueueCache_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">BLOGN_FAILURE_ID</span><span class="token punctuation">(</span>sequence<span class="token punctuation">,</span> <span class="token string">"not found in cache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> GSERROR_NO_ENTRY<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isShared_ <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">auto</span> <span class="token operator">&amp;</span>state <span class="token operator">=</span> bufferQueueCache_<span class="token punctuation">[</span>sequence<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> BUFFER_STATE_REQUESTED <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> BUFFER_STATE_ATTACHED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">BLOGN_FAILURE_ID</span><span class="token punctuation">(</span>sequence<span class="token punctuation">,</span> <span class="token string">"invalid state %&#123;public&#125;d"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> GSERROR_NO_ENTRY<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>listener_ <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> listenerClazz_ <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">CancelBuffer</span><span class="token punctuation">(</span>sequence<span class="token punctuation">,</span> bedata<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> GSERROR_NO_CONSUMER<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    ScopedBytrace <span class="token function">bufferIPCSend</span><span class="token punctuation">(</span><span class="token string">"BufferIPCSend"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sret <span class="token operator">=</span> <span class="token function">DoFlushBuffer</span><span class="token punctuation">(</span>sequence<span class="token punctuation">,</span> bedata<span class="token punctuation">,</span> fence<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sret <span class="token operator">!=</span> GSERROR_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> sret<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">CountTrace</span><span class="token punctuation">(</span>HITRACE_TAG_GRAPHIC_AGP<span class="token punctuation">,</span> name_<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>dirtyList_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sret <span class="token operator">==</span> GSERROR_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listener_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            ScopedBytrace <span class="token function">bufferIPCSend</span><span class="token punctuation">(</span><span class="token string">"OnBufferAvailable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            listener_<span class="token operator">-></span><span class="token function">OnBufferAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>listenerClazz_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            ScopedBytrace <span class="token function">bufferIPCSend</span><span class="token punctuation">(</span><span class="token string">"OnBufferAvailable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            listenerClazz_<span class="token operator">-></span><span class="token function">OnBufferAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">BLOGND</span><span class="token punctuation">(</span><span class="token string">"Success Buffer seq id: %&#123;public&#125;d Queue id: %&#123;public&#125;"</span> PRIu64 <span class="token string">" AcquireFence:%&#123;public&#125;d"</span><span class="token punctuation">,</span>
        sequence<span class="token punctuation">,</span> uniqueId_<span class="token punctuation">,</span> fence<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p><code>DoFlushBuffer</code> 函数会调用 Display 驱动的 <code>FlushCache</code> 函数，关于 Display 驱动可以查阅 <code>drivers/peripheral/display</code> 目录。</p><h3 id="开机动画结束条件"><a href="#开机动画结束条件" class="headerlink" title="开机动画结束条件"></a>开机动画结束条件</h3><p>程序将根据先前设置的回调频率调用 <code>BootAnimation::OnVsync</code>，<code>BootAnimation::OnVsync</code> 又将调用 <code>BootAnimation::Draw</code></p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>picCurNo_ <span class="token operator">&lt;</span> <span class="token punctuation">(</span>imgVecSize_ <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    picCurNo_ <span class="token operator">=</span> picCurNo_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">CheckExitAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>显而易见的，<code>Draw</code> 函数会进行条件判断，将图片文件压缩包中的图片逐个绘制送显。若所有图片都已渲染，则调用 <code>CheckExitAnimation</code> 函数，不再调用后续的 <code>OnDraw</code> 函数。</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">BootAnimation</span><span class="token double-colon punctuation">::</span><span class="token function">CheckExitAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"CheckExitAnimation enter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>setBootEvent_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"CheckExitAnimation set bootevent parameter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        system<span class="token double-colon punctuation">::</span><span class="token function">SetParameter</span><span class="token punctuation">(</span><span class="token string">"bootevent.bootanimation.started"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        setBootEvent_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    std<span class="token double-colon punctuation">::</span>string windowInit <span class="token operator">=</span> system<span class="token double-colon punctuation">::</span><span class="token function">GetParameter</span><span class="token punctuation">(</span><span class="token string">"persist.window.boot.inited"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>windowInit <span class="token operator">==</span> <span class="token string">"1"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">PostTask</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AppExecFwk<span class="token double-colon punctuation">::</span>EventRunner<span class="token double-colon punctuation">::</span>Stop<span class="token punctuation">,</span> runner_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"CheckExitAnimation read windowInit is 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre><p><code>CheckExitAnimation</code> 函数将读取系统参数，判断当前系统是否已启动完成。</p><ul><li>若系统已启动完成，则通过 <code>PostTask(std::bind(&amp;AppExecFwk::EventRunner::Stop, runner_));</code> 结束开机动画进程。</li><li>若系统未启动完成，则继续等待下一次 <code>OnVsync</code> 调用。此时，屏幕将维持显示最后一帧的画面。</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>OpenHarmony 开机动画的渲染过程是从 render_service 获取 Buffer，在 Client 端用 Buffer + Skia 创建 Canvas 进行绘制，并逐个图片 flush 到 render_service 的 Server 端，最终完成送显。</p><div class="note warning flat"><p>本文基于 OpenHarmony 3.2 源码。</p><p>由于 OpenHarmony 尚未稳定，源代码和项目仓库结构变更速度和幅度都较大，请读者直接参照 OpenHarmony 3.2 源码阅读本文。</p></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/hydrotho">名無し</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://hydrotho.github.io/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/">https://hydrotho.github.io/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hydrotho.github.io" target="_blank">名無し's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OpenHarmony/">OpenHarmony</a></div><div class="post_share"><div class="social-share" data-image="/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/cover.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/Compiling-Python-Application-Into-Static-Binary-Using-PyInstaller-And-StaticX/" title="Python 编译「静态」可执行文件 (PyInstaller + StaticX)"><img class="cover" src="/Compiling-Python-Application-Into-Static-Binary-Using-PyInstaller-And-StaticX/cover.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python 编译「静态」可执行文件 (PyInstaller + StaticX)</div></div></a></div><div class="next-post pull-right"><a href="/How-To-Use-Node-Version-Manager-With-JetBrains-Tools/" title="解决 Linux 下 JetBrains 全家桶无法识别使用 Node 版本管理器安装的 Node 的问题"><img class="cover" src="/How-To-Use-Node-Version-Manager-With-JetBrains-Tools/cover.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">解决 Linux 下 JetBrains 全家桶无法识别使用 Node 版本管理器安装的 Node 的问题</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/An-Overview-Of-Several-Ways-To-Implement-Page-Routing-In-Openharmony/" title="浅谈 OpenHarmony 中北向应用实现页面跳转的几种方式"><img class="cover" src="/An-Overview-Of-Several-Ways-To-Implement-Page-Routing-In-Openharmony/cover.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-05</div><div class="title">浅谈 OpenHarmony 中北向应用实现页面跳转的几种方式</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqusjs-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.webp" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">名無し</div><div class="author-info__description">折腾 ∞ --- Just for Fun</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/hydrotho"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/hydrotho" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:vmlpead54@mozmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">如果文章对您有所帮助的话，不妨关注我并把文章分享给您的朋友。😘😘😘</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E4%BB%93%E5%BA%93"><span class="toc-number">1.</span> <span class="toc-text">源码仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%AF%BC%E7%9F%A5%E8%AF%86%EF%BC%9A%E6%9E%84%E5%BB%BA%E7%9B%AE%E6%A0%87"><span class="toc-number">2.</span> <span class="toc-text">前导知识：构建目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-number">3.1.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.2.</span> <span class="toc-text">初始化工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E7%BB%98%E5%88%B6%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB"><span class="toc-number">3.3.</span> <span class="toc-text">渲染绘制开机动画</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB%E7%BB%93%E6%9D%9F%E6%9D%A1%E4%BB%B6"><span class="toc-number">3.4.</span> <span class="toc-text">开机动画结束条件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/Analysis-Of-The-Causes-And-Solutions-Of-Systemd-In-Degraded-State-In-WSL2/" title="WSL2 中 Systemd 处于降级状态的原因分析及解决方案">WSL2 中 Systemd 处于降级状态的原因分析及解决方案</a><time datetime="2022-11-30T04:00:00.000Z" title="发表于 2022-11-30 12:00:00">2022-11-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/Compiling-Python-Application-Into-Static-Binary-Using-PyInstaller-And-StaticX/" title="Python 编译「静态」可执行文件 (PyInstaller + StaticX)">Python 编译「静态」可执行文件 (PyInstaller + StaticX)</a><time datetime="2022-10-10T04:00:00.000Z" title="发表于 2022-10-10 12:00:00">2022-10-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/" title="解读 OpenHarmony 系统开机动画源码">解读 OpenHarmony 系统开机动画源码</a><time datetime="2022-09-15T04:00:00.000Z" title="发表于 2022-09-15 12:00:00">2022-09-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/How-To-Use-Node-Version-Manager-With-JetBrains-Tools/" title="解决 Linux 下 JetBrains 全家桶无法识别使用 Node 版本管理器安装的 Node 的问题">解决 Linux 下 JetBrains 全家桶无法识别使用 Node 版本管理器安装的 Node 的问题</a><time datetime="2022-09-10T04:00:00.000Z" title="发表于 2022-09-10 12:00:00">2022-09-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/An-Overview-Of-Several-Ways-To-Implement-Page-Routing-In-Openharmony/" title="浅谈 OpenHarmony 中北向应用实现页面跳转的几种方式">浅谈 OpenHarmony 中北向应用实现页面跳转的几种方式</a><time datetime="2022-09-05T04:00:00.000Z" title="发表于 2022-09-05 12:00:00">2022-09-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2024 By 名無し</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(()=>{const s=()=>{window.disqusjs=null,(disqusjs=new DisqusJS(Object.assign({shortname:"hydrotho",identifier:"/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/",url:"https://hydrotho.github.io/Analysis-Of-The-Boot-Screen-Source-Code-Of-OpenHarmony/",title:"解读 OpenHarmony 系统开机动画源码",apikey:"nKXeGyZaqlQH4l99kX28pPboURf9grBC0XO9veo20AbiRvWp5IT1KJ7w8DBlmm7L"},null))).render(document.getElementById("disqusjs-wrap"))};btf.addGlobalFn("themeChange",()=>{document.getElementById("disqus_thread")&&(disqusjs.destroy(),s())},"disqusjs");var e=async()=>{window.disqusJsLoad?s():(await getCSS("https://cdn.jsdelivr.net/npm/disqusjs@3.0.2/dist/browser/styles/disqusjs.min.css"),await getScript("https://cdn.jsdelivr.net/npm/disqusjs@3.0.2/dist/browser/disqusjs.es2015.umd.min.js"),s(),window.disqusJsLoad=!0)};btf.loadComment(document.getElementById("disqusjs-wrap"),e)})()</script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.12.0"></script></div></div></body></html>